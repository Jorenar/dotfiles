#!/usr/bin/env -S make -s -f

MAKEFLAGS += -B --no-print-directory
.PHONY: CMakeLists.txt
.ONESHELL:

CFLAGS := -Wall -Wextra -pedantic -g -lm


%:
	echo "No rule for filetype found; reverting to normal make command:"
	echo " > " $(MAKE) $*
	$(MAKE) $*


%.c:
	$(CC)  $(CFLAGS) -std=gnu99   $@ -o $(*F)

%.cpp:
	$(CXX) $(CFLAGS) -std=gnu++14 $@ -o $(*F)

%.latex:
	latexmk -outdir=$(*F).out.d -pdfxe -interaction=nonstopmode $@ 1>&2

%.nasm:
	nasm -f elf64 -g $@
	ld -g -o $(*F) $(*F).o
	$(RM) $(*F).o

%.asm:
	$(AS) -o $(*F).o $@
	ld -s -o $(*F) $(*F).o
	$(RM) $(*F).o

%.cs:
	mcs $@

%.rs:
	rustc $(*F)

%.java:
	javac -d $(TMPDIR)/java $@
	jar cvfe $(*F).jar $(*F) -C $(TMPDIR)/java .

%.cobol %.cob %.cbl:
	cobc -d -O -x -o $(*F) $@

%.go:
	go build

%.html:
	tidy -quiet -errors --gnu-emacs yes $@

%.xhtml:
	tidy -asxhtml -quiet -errors --gnu-emacs yes $@

%.ada:
	gnatmake $@
	gnatclean -c $@

%.py:
	python $@

%.sh:
	shellcheck $@


CMakeLists.txt: $(PWD)/CMakeLists.txt
%/CMakeLists.txt:
	[ -n "$(*F)" ] && cd $(*F)
	cmake -B build/ -DCMAKE_BUILD_TYPE=Debug
	cmake --build build/ 2> >(tee build/errors.err >&2)
