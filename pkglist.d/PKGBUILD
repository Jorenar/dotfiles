#!/usr/bin/makepkg -fisc
# shellcheck shell=bash disable=SC2016,SC2034

# preamble {{{

pkgname=my-metapkg
pkgver=1; pkgrel=1
arch=(any)
depends=()

package() {
  if [ -z "$MYMETAPKG_GROUPS" ]; then
    mapfile -t _grps <<< "$(compgen -A function '_gr_' | sed 's/^_gr_//')"
  else
    IFS=' ' read -r -a _grps <<< "$MYMETAPKG_GROUPS"
  fi
  _grps+=(BASE ESSENTIALS)

  declare -A _guarr  # must be declared in package()
  _guardo='[[ -v _guarr[$FUNCNAME] ]] && return || _guarr[$FUNCNAME]=1'

  if [ -n "$MYMETAPKG_INCLUDE" ]; then
    IFS=' ' read -r -a depends <<< "$MYMETAPKG_INCLUDE"
  fi

  for g in "${_grps[@]}"; do
    [ -n "$g" ] && _gr_"$g"
  done

  for p in $MYMETAPKG_EXCLUDE; do
    depends=( "${depends[@]/$p}" )
  done

  IFS=$'\n'
  mapfile -t depends <<< "$(sort -u <<< "${depends[*]}" | grep -v '^$')"
  unset IFS

  echo "${depends[@]}"
}

# }}}

_gr_BASE() {
  eval "$_guardo"

  depends+=(
    base
    linux
    linux-lts
    linux-firmware
    linux-headers
    sudo
  )

  depends+=(
    posix
    posix-c-development
    posix-software-development
    posix-user-portability
    posix-xsi
  )

  if grep -qiw AMD /proc/cpuinfo; then
    depends+=(amd-ucode)
  elif grep -qiw Intel /proc/cpuinfo; then
    depends+=(intel-ucode)
  fi
  depends+=(cpupower lm_sensors)

  if [ -d /proc/driver/nvidia ] \
      || grep -qi nvidia-gpu /sys/bus/pci/devices/**/uevent
  then
    depends+=(
      nvidia-open
      nvidia-settings
    )
  fi

  if rfkill -o TYPE | grep -q wlan; then
    depends+=( iw iwd )
  fi

  if rfkill -o TYPE | grep -q bluetooth; then
    depends+=( bluetui bluez-obex bluez-tools )
  fi
}
_gr_ESSENTIALS() {
  eval "$_guardo"

  depends+=(
    pacman-contrib
    reflector

    man-db
    man-pages

    ethtool
    fail2ban
    inetutils
    ufw

    bash
    bash-completion
    dash
    tmux

    fzf
    git
    gvfs
    gvim
    htop
    openssh
    pass

    dosfstools
    udisks2
    curlftpfs
    sshfs
    rsync

    lhasa
    p7zip
    unp
    unrar
    unzip
    zip
  )
}

_gr_DEV() {
  eval "$_guardo"

  depends+=(
    base-devel
    multilib-devel

    gvim
    neovim
    python-pynvim
    cscope
    ctags

    ccache
    clang
    cmake
    cppcheck
    doxygen
    flawfinder
    gdb
    graphviz
    radare2
    strace
    uncrustify
    valgrind

    chromium
    deno
    expect
    go
    jq
    jre-openjdk
    lua51
    nasm
    npm
    openscad
    python
    rust
    tectonic
    texlive-binextra
    tidy
  )
}
_gr_MAIL() {
  eval "$_guardo"

  depends+=(
    aerc
    isync
    msmtp
    notmuch
    # cyrus-sasl-xoauth2-git
  )
}
_gr_DESKTOP() {
  eval "$_guardo"

  depends+=(
    gnu-free-fonts
    ttf-dejavu
    ttf-nerd-fonts-symbols
    wqy-zenhei

    alsa-utils
    pulsemixer
    pipewire-pulse

    qt5ct
    qt6ct
    xdg-utils
  )
}
_gr_X11() {
  eval "$_guardo"

  depends+=(
    dmenu
    xclip
    xdotool
    xf86-input-wacom
    xorg-server
    xorg-xev
    xorg-xinit
    xorg-xprop
    xorg-xrandr
    xterm
  )
}
_gr_WAYLAND() {
  eval "$_guardo"

  depends+=(
    foot
    fuzzel
    qt5-wayland
    waypipe
    wev
    wl-clipboard
    wtype
    xorg-xprop
    xorg-xwayland
  )
}
_gr_I3WM() {
  eval "$_guardo"
  _gr_X11
  _gr_DESKTOP i3

  depends+=(
    dunst
    i3-wm
    polybar
    scrot
  )
}
_gr_SWAY() {
  eval "$_guardo"
  _gr_WAYLAND
  _gr_DESKTOP sway

  depends+=(
    cliphist
    dunst
    grim
    nwg-displays
    slurp
    sway
    swaybg
    waybar
    wlsunset
  )
}
_gr_VIRT() {
  eval "$_guardo"

  depends+=(
    podman
    podman-docker
    fuse-overlayfs

    libvirt
    qemu-desktop
    virt-install
    virt-viewer

    wine
    wine-mono
    wine-gecko
  )
}
_gr_GAMING() {
  eval "$_guardo"
  _gr_DESKTOP

  depends+=(
    steam
    dosbox
  )
}
_gr_TUIAPPS() {
  eval "$_guardo"

  depends+=(
    khal
    newsboat
    ranger
    vdirsyncer
    visidata
    w3m
    weechat
  )
}
_gr_GUIAPPS() {
  eval "$_guardo"
  _gr_DESKTOP

  depends+=(
    firefox
    imv
    libreoffice-still
    mpv
    zathura
    zathura-pdf-mupdf
    zathura-ps
  )
}
_gr_CREATIVE() {
  eval "$_guardo"
  _gr_DESKTOP

  depends+=(
    gimp
    inkscape
    kicad
    krita
    obs-studio
    shotcut
    tenacity
  )
}
_gr_UTILS() {
  eval "$_guardo"

  depends+=(
    # tigervnc
    imagemagick
    lsix
    ncdu
    python-pipx
    sane
    termshark
    transmission-cli
    yt-dlp
  )
}
_gr_EXTRA() {
  eval "$_guardo"

  depends+=(
    android-file-transfer
    gphoto2
    heimdall # flashing ROMs onto Galaxy devices
    i2pd
    ifuse # fuse for iOS
    scrcpy # display and control Android device
  )
}
