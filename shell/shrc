#!sh

if [ -x "$(command -v tmux)" ] && [ -n "$DISPLAY" ] && [ -z "$TMUX" ] && [ -z "$SSH_CLIENT" ]; then
    if ps -ef | grep tmux | grep -v -q grep; then
        exec tmux attach \; new-session
    else
        exec tmux -f $XDG_CONFIG_HOME/tmux/tmux.conf
    fi
fi

# Init ------------------------------------------------------------------------

# Source env variables
. $XDG_CONFIG_HOME/env/variables

# History size
export HISTSIZE=

# Restore OLDPWD
[ -f "$HISTORY_DIR/oldpwd" ] && . "$HISTORY_DIR/oldpwd"

# Logout
trap "[ -f "$XDG_CONFIG_HOME/shell/logout" ] && . $XDG_CONFIG_HOME/shell/logout" EXIT

# Source aliases
. $XDG_CONFIG_HOME/shell/aliases

# FZF
. $XDG_CONFIG_HOME/shell/fzf.sh

# Source local additional shell config
[ -f $HOSTDOTS/shell ] && . $HOSTDOTS/shell


# PROMPT

PS1='$(_ps1)'
_ps1 () {
    printf '\001\033]0;%s@%s:%s\007\002' \
        "$USER"  "$(uname -n)"  "$(echo "$PWD" | sed "s,^$HOME,~,")"

    if [ -z "$SHORT_PROMPT" ]; then
        printf "\001\033[38;5;240m\002"
        printf '(%s){%d}  [ %s@%s  %s %s]' \
            "$(ps -p "$$" -o comm='')" \
            "$(jobs | wc -l)" \
            "$USER" \
            "$(uname -n)" \
            "$(echo $PWD | sed "s,^$HOME\(\/\|$\),~/,")" \
            "$(git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ \1 /')"
        [ -n "$TMUX" ] && printf '  [ %s]' "$(tmux list-windows -F "#{E:window-status-format}" | tr "\n" " ")"
        printf "\001\033[0m\002"
        printf "\n"
    fi

    printf '\001\033[36m\002$\001\033[0m\002 '
}
